<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ูุญูุธุชู (My Wealth)</title>
    <link rel="stylesheet" href="style.css?v=11">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&family=Inter:wght@400;600;800&display=swap"
        rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>

<body data-view="auth">

    <div class="ambient-glow"></div>

    <!-- ูุธุงู ุงูุฅุดุนุงุฑุงุช -->
    <div id="toast-container"></div>

    <section id="auth-section" class="view-section">
        <div class="container"
            style="height:80vh; display:flex; flex-direction:column; justify-content:center; text-align:center;">
            <i class="fa-solid fa-layer-group" style="font-size:3.5rem; color:var(--primary); margin-bottom:20px;"></i>
            <h1 style="margin:0 0 10px; font-size:1.8rem">ูุญูุธุชู</h1>
            <p style="color:#888; margin-bottom:40px; font-size:0.9rem">ุฅุฏุงุฑุฉ ุงูุฃุตูู ููุญุงูุงุฉ ุงูุณูู</p>

            <input type="email" id="login-email" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู">
            <input type="password" id="login-password" placeholder="ูููุฉ ุงููุฑูุฑ">
            <button class="btn-primary" id="login-btn">ุชุณุฌูู ุงูุฏุฎูู</button>
        </div>
    </section>

    <section id="dashboard-section" class="view-section hidden">
        <div class="container">
            <!-- Market Ticker -->
            <div class="market-ticker-inline glass-card-nav" id="ticker-bar"
                style="margin-bottom: 15px; padding: 8px 15px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:0.8rem; color:#aaa;">
                    <i class="fa-solid fa-spinner fa-spin"></i> ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงูุณูู...
                </span>
                <!-- Manual Install Trigger -->
                <button id="manual-install-trigger" class="icon-btn-sm"
                    style="background:transparent; color:var(--primary); display:none;"
                    onclick="document.getElementById('pwa-install-modal').showModal()">
                    <i class="fa-solid fa-download"></i>
                </button>
            </div>

            <!-- ุจุทุงูุฉ ุงูุซุฑูุฉ ุงูุฑุฆูุณูุฉ -->
            <div class="glass-card main-wealth-card">
                <div class="wealth-header">
                    <div class="wealth-text">
                        <div class="mc-label">ุฅุฌูุงูู ุงูุซุฑูุฉ</div>
                        <h1 class="mc-value" id="total-net-worth">...</h1>
                        <div class="wealth-change" id="wealth-change">
                            <i class="fa-solid fa-arrow-up"></i> <span>--</span>
                        </div>
                    </div>
                    <div id="lottie-wealth" style="width: 120px; height: 120px;"></div>
                </div>

                <div class="wealth-stats-row">
                    <div class="w-stat">
                        <i class="fa-solid fa-wallet"></i>
                        <span id="total-invested" class="ws-value">EGP 0</span>
                        <span class="ws-label">ุฑุฃุณ ุงููุงู</span>
                    </div>
                    <div class="w-stat">
                        <i class="fa-solid fa-chart-line"></i>
                        <span id="total-pnl" class="ws-value success-text">EGP 0</span>
                        <span class="ws-label">ุงูุฃุฑุจุงุญ</span>
                    </div>
                    <div class="w-stat">
                        <i class="fa-solid fa-percent"></i>
                        <span id="global-avg-return" class="ws-value">0%</span>
                        <span class="ws-label">ูุชูุณุท ุงูุนุงุฆุฏ</span>
                    </div>
                </div>
            </div>

            <div class="section-header">
                <h3>ุงููุญุงูุธ</h3>
                <button class="btn-add-stylish" id="create-portfolio-btn">
                    <i class="fa-solid fa-plus"></i> ุฅุถุงูุฉ
                </button>
            </div>

            <div id="portfolios-container"></div>
        </div>
    </section>

    <!-- Create Portfolio Modal -->
    <dialog id="create-portfolio-modal" class="modal">
        <div class="modal-content glass-card">
            <button onclick="document.getElementById('create-portfolio-modal').close()"
                style="position:absolute; top:20px; left:20px; background:none; border:none; color:#888; font-size:1.2rem; cursor:pointer;">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <h3 style="margin-bottom: 20px;">ูุญูุธุฉ ุฌุฏูุฏุฉ</h3>
            <div class="input-group">
                <label>ุงุณู ุงููุญูุธุฉ</label>
                <input type="text" id="new-p-name" placeholder="ูุซูุงู: Thndr, WayBetter...">
            </div>

            <div class="input-group">
                <label>ุงูุนููุฉ</label>
                <div class="currency-selector">
                    <input type="radio" name="p-curr" value="EGP" id="curr-egp" checked>
                    <label for="curr-egp" class="radio-label">EGP (ุฌ.ู)</label>

                    <input type="radio" name="p-curr" value="USD" id="curr-usd">
                    <label for="curr-usd" class="radio-label">USD ($)</label>
                </div>
            </div>

            <div class="input-group">
                <label>ุฑุฃุณ ุงููุงู ุงููุจุฏุฆู (ุฅูุฏุงุน)</label>
                <input type="number" id="new-p-cap" placeholder="0">
            </div>

            <div class="modal-actions">
                <button class="btn-text" onclick="window.closeModal()">ุฅูุบุงุก</button>
                <button class="btn-primary" onclick="window.submitNewPortfolio()">ุฅูุดุงุก</button>
            </div>
        </div>
    </dialog>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
    </div>

    <!-- DETAILS SECTION -->
    <section id="details-section" class="view-section hidden">
        <div class="container">
            <!-- Header & Actions -->
            <div class="details-header">
                <button class="btn-icon" onclick="window.setView('dashboard')">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                <div class="header-title-wrapper">
                    <h2 id="d-p-name">...</h2>
                    <button class="btn-edit-icon" onclick="window.editPortfolioCapital()" title="ุชุนุฏูู ุฑุฃุณ ุงููุงู">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                </div>
                <button class="btn-icon danger" onclick="window.deleteCurrentPortfolio()">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>

            <!-- Hero Analytics Card -->
            <div class="hero-analytics-card">
                <div class="hero-main-value">
                    <span class="currency-label" id="d-p-currency">EGP</span>
                    <div style="display:flex; align-items:center; gap:10px; justify-content:center">
                        <span id="d-p-val" class="hero-number">0</span>
                        <button class="btn-update-balance" onclick="window.updateCurrentBalance()"
                            title="ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู">
                            <i class="fa-solid fa-rotate"></i> ุชุญุฏูุซ ุงููููุฉ
                        </button>
                    </div>
                </div>

                <div class="hero-stats-row">
                    <!-- Profit/Loss Block -->
                    <div class="hero-stat-item">
                        <div class="stat-icon-box" id="pnl-icon-box">
                            <i id="pnl-icon" class="fa-solid fa-chart-line"></i>
                        </div>
                        <div class="stat-text-col">
                            <span class="stat-label-tiny">ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ</span>
                            <span id="d-p-profit" class="stat-number-small">0</span>
                        </div>
                    </div>

                    <div class="vertical-divider"></div>

                    <!-- ROI Block -->
                    <div class="hero-stat-item">
                        <div class="stat-icon-box">
                            <i class="fa-solid fa-percent"></i>
                        </div>
                        <div class="stat-text-col">
                            <span class="stat-label-tiny">ุงูุนุงุฆุฏ %</span>
                            <span id="d-p-roi" class="stat-number-small">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Secondary Stats Row -->
                <div class="hero-stats-row secondary-stats">
                    <div class="hero-stat-item compact">
                        <span class="stat-label-tiny">ุฅุฌูุงูู ุงูุฅูุฏุงุน</span>
                        <span id="d-p-deposits" class="stat-number-tiny text-green">0</span>
                    </div>
                    <div class="vertical-divider mini"></div>
                    <div class="hero-stat-item compact">
                        <span class="stat-label-tiny">ุงูุฃุฑุจุงุญ ุงููุณุญูุจุฉ</span>
                        <span id="d-p-withdrawals" class="stat-number-tiny text-danger">0</span>
                    </div>
                    <div class="vertical-divider mini"></div>
                    <div class="hero-stat-item compact">
                        <span class="stat-label-tiny">ูุชูุณุท ุงูุนุงุฆุฏ</span>
                        <span id="d-p-avg-return" class="stat-number-tiny text-blue">0%</span>
                    </div>
                </div>
            </div>

            <div class="hero-bg-glow"></div>
        </div>

        <!-- Chart Section -->
        <div class="glass-card chart-container">
            <div class="chart-header-row">
                <h3 class="card-title">
                    <i class="fa-solid fa-wave-square" style="color:var(--primary)"></i>
                    ุงููููุฉ ุงูุณูููุฉ
                </h3>
                <div class="chart-filters">
                    <button class="filter-btn active" onclick="updateChartFilter('1W')">ุฃุณุจูุน</button>
                    <button class="filter-btn" onclick="updateChartFilter('1M')">ุดูุฑ</button>
                    <button class="filter-btn" onclick="updateChartFilter('1Y')">ุณูุฉ</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>

        <!-- Valuation History Section -->
        <div class="glass-card history-container">
            <div class="chart-header-row" style="margin-bottom:15px">
                <h3 class="card-title">
                    <i class="fa-solid fa-clock-rotate-left" style="color:var(--primary)"></i>
                    ุณุฌู ุงูููู
                </h3>
            </div>

            <div class="table-responsive">
                <table class="modern-table" id="valuation-history-table">
                    <thead>
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงููููุฉ</th>
                            <th>ุงูุญุงูุฉ</th>
                            <th style="text-align: left;">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="history-list-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>

            <div id="history-empty-state" class="empty-state hidden">
                <i class="fa-solid fa-clipboard-list"></i>
                <p>ูุง ููุฌุฏ ุณุฌูุงุช ุจุนุฏ. ุงุจุฏุฃ ุจุชุญุฏูุซ ุฑุตูุฏ ุงููุญูุธุฉ.</p>
            </div>
        </div>

        <!-- Update Balance Modal -->
        <dialog id="update-balance-modal" class="modal">
            <div class="modal-content glass-card">
                <button onclick="document.getElementById('update-balance-modal').close()"
                    style="position:absolute; top:20px; left:20px; background:none; border:none; color:#888; font-size:1.2rem; cursor:pointer;">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <h3>ุชุญุฏูุซ ุฑุตูุฏ ุงููุญูุธุฉ</h3>

                <div class="input-group">
                    <label>ุงูุชุงุฑูุฎ</label>
                    <input type="date" id="ub-date">
                </div>

                <div class="input-group">
                    <label>ุงููููุฉ ุงูุณูููุฉ ุงูุญุงููุฉ (Current Value)</label>
                    <input type="number" id="ub-value" placeholder="ุงููููุฉ ุงูุฅุฌูุงููุฉ ูููุญูุธุฉ ุงูุขู">
                    <small style="color:#888">ุฃุฏุฎู ุงููููุฉ ุงูุชู ุชุฑุงูุง ูู ุชุทุจูู ุงููุญูุธุฉ ุงูุฎุงุต ุจู ุงูุขู.</small>
                </div>

                <div class="section-divider"></div>

                <div class="input-group">
                    <label>ูู ููุช ุจุฅูุฏุงุน ุฃู ุณุญุจ ุฃููุงูุ</label>
                    <div class="currency-selector" style="margin-bottom:10px">
                        <input type="radio" name="ub-type" value="NONE" id="type-none" checked
                            onchange="toggleCashFlowInput()">
                        <label for="type-none" class="radio-label">ูุง ุชุบููุฑ</label>

                        <input type="radio" name="ub-type" value="DEPOSIT" id="type-dep"
                            onchange="toggleCashFlowInput()">
                        <label for="type-dep" class="radio-label">ุฅูุฏุงุน</label>

                        <input type="radio" name="ub-type" value="WITHDRAW" id="type-with"
                            onchange="toggleCashFlowInput()">
                        <label for="type-with" class="radio-label">ุณุญุจ</label>
                    </div>

                    <div id="cash-flow-input-container" class="hidden">
                        <input type="number" id="ub-cash-amount" placeholder="ูููุฉ ุงููุจูุบ ุงูููุฏุน/ุงููุณุญูุจ">
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-text" onclick="window.closeModal()">ุฅูุบุงุก</button>
                    <button class="btn-primary" onclick="window.submitBalanceUpdate()">ุญูุธ</button>
                </div>
            </div>
        </dialog>
    </section>

    <!-- CALCULATOR SECTION -->
    <section id="calculator-section" class="view-section hidden">
        <div class="container">
            <div class="tools-header">
                <div>
                    <h2 class="section-title">ุฃุฏูุงุช ุงูุชุฏุงูู</h2>
                    <p class="section-subtitle">ุญุงุณุจุงุชุ ุชุญูููุ ูุฅุฏุงุฑุฉ ูุฎุงุทุฑ</p>
                </div>
            </div>

            <!-- Modern Segmented Control -->
            <div class="glass-card compact-card" style="padding: 8px; margin-bottom: 20px;">
                <div class="segmented-control-modern">
                    <button class="sc-btn active" onclick="window.switchCalcTab('global', this)">
                        <span class="sc-icon"><i class="fa-solid fa-globe"></i></span>
                        <span class="sc-label">ุดุงูู</span>
                    </button>
                    <button class="sc-btn" onclick="window.switchCalcTab('levels', this)">
                        <span class="sc-icon"><i class="fa-solid fa-layer-group"></i></span>
                        <span class="sc-label">ูุณุชููุงุช</span>
                    </button>
                    <button class="sc-btn" onclick="window.switchCalcTab('fees', this)">
                        <span class="sc-icon"><i class="fa-solid fa-receipt"></i></span>
                        <span class="sc-label">ุนูููุงุช</span>
                    </button>
                    <button class="sc-btn" onclick="window.switchCalcTab('avg', this)">
                        <span class="sc-icon"><i class="fa-solid fa-calculator"></i></span>
                        <span class="sc-label">ุชูุณุท</span>
                    </button>
                    <button class="sc-btn" onclick="window.switchCalcTab('risk', this)">
                        <span class="sc-icon"><i class="fa-solid fa-shield-halved"></i></span>
                        <span class="sc-label">ูุฎุงุทุฑุฉ</span>
                    </button>
                </div>
            </div>

            <!-- LEVELS TAB -->
            <div id="calc-levels" class="calc-tab-content">
                <div class="glass-card tool-card">
                    <div class="broker-selector" style="margin-bottom:15px">
                        <div class="broker-option selected" onclick="window.switchLevelType('fib', this)">
                            ููุจููุงุชุดู
                        </div>
                        <div class="broker-option" onclick="window.switchLevelType('pivot', this)">
                            ุงูุฏุนูู (Pivots)
                        </div>
                    </div>

                    <!-- FIBONACCI -->
                    <div id="lvl-fib-sec">
                        <p class="section-subtitle" style="margin-bottom:15px; font-size:0.8rem">
                            ุฃุฏุฎู ููุฉ ููุงุน <strong>ุงูููุฌุฉ ุงูุญุงููุฉ</strong> ุงูุชู ุชุฑูุฏ ุชุญููููุง.
                        </p>
                        <div class="compact-grid">
                            <div class="input-group-modern success-theme">
                                <label>ุงูููุฉ (High)</label>
                                <input type="number" id="fib-high" placeholder="ุฃุนูู ุณุนุฑ" oninput="window.calcFib()">
                            </div>
                            <div class="input-group-modern danger-theme">
                                <label>ุงููุงุน (Low)</label>
                                <input type="number" id="fib-low" placeholder="ุฃูู ุณุนุฑ" oninput="window.calcFib()">
                            </div>
                        </div>
                        <div class="input-group-modern" style="margin-top:10px;">
                            <label>ุงุชุฌุงู ุงูููุฌุฉ:</label>
                            <select id="fib-trend" class="modern-input" onchange="window.calcFib()">
                                <option value="UP">ุตุงุนุฏุฉ (ุชุตุญูุญ ูุฃุณูู)</option>
                                <option value="DOWN">ูุงุจุทุฉ (ุงุฑุชุฏุงุฏ ูุฃุนูู)</option>
                            </select>
                        </div>
                        <div id="fib-results" class="hidden-fade-in" style="margin-top:20px"></div>
                    </div>

                    <!-- PIVOT POINTS -->
                    <div id="lvl-pivot-sec" class="hidden">
                        <p class="section-subtitle" style="margin-bottom:15px; font-size:0.8rem">
                            ุฃุฏุฎู ุจูุงูุงุช ุดูุนุฉ <strong>ุงูููู ุงูุณุงุจู</strong> ูุญุณุงุจ ูุณุชููุงุช ุงูููู.
                        </p>
                        <div class="compact-grid">
                            <div class="input-group-modern">
                                <label>ุงูุฃุนูู (High)</label>
                                <input type="number" id="piv-high" placeholder="ูุงู ุฃูุณ" oninput="window.calcPivots()">
                            </div>
                            <div class="input-group-modern">
                                <label>ุงูุฃุฏูู (Low)</label>
                                <input type="number" id="piv-low" placeholder="ูู ุฃูุณ" oninput="window.calcPivots()">
                            </div>
                            <div class="input-group-modern">
                                <label>ุงูุฅุบูุงู (Close)</label>
                                <input type="number" id="piv-close" placeholder="ุฅุบูุงู ุฃูุณ"
                                    oninput="window.calcPivots()">
                            </div>
                        </div>
                        <div id="piv-results" class="hidden-fade-in" style="margin-top:20px"></div>
                    </div>
                </div>
            </div>

            <!-- GLOBAL ANALYZER TAB -->
            <div id="calc-global" class="calc-tab-content active">
                <div class="glass-card tool-card">
                    <div class="input-with-icon">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" id="global-search-input" class="modern-input"
                            placeholder="ุงุจุญุซ ุนู ุฑูุฒ ุงูุณูู (ูุซูุงู EGAL)" oninput="window.calcGlobalStats(this.value)">
                    </div>

                    <div id="global-results" class="hidden-fade-in" style="display:none;">
                        <div class="global-stats-grid">
                            <div class="g-stat-box gold-glow">
                                <span class="g-label">ุงููุชูุณุท ุงูุดุงูู</span>
                                <strong id="g-avg-price" class="g-value">0.00</strong>
                            </div>
                            <div class="g-stat-box">
                                <span class="g-label">ุฅุฌูุงูู ุงููููุฉ</span>
                                <strong id="g-total-qty" class="g-value">0</strong>
                            </div>
                            <div class="g-stat-box">
                                <span class="g-label">ุงููููุฉ ุงูุณูููุฉ</span>
                                <strong id="g-mkt-val" class="g-value">0.00</strong>
                            </div>
                        </div>
                        <div class="divider-line"></div>
                        <h4 class="mini-header">ุงูุชูุฒูุน ุญุณุจ ุงููุญูุธุฉ</h4>
                        <div id="global-breakdown-list" class="breakdown-list"></div>
                    </div>

                    <div id="global-empty" class="empty-placeholder">
                        <div class="placeholder-icon">
                            <i class="fa-brands fa-searchengin"></i>
                        </div>
                        <p>ุงุจุฏุฃ ุงููุชุงุจุฉ ูุนุฑุถ ุชุญููู ุดุงูู ููุฃุตู ุนุจุฑ ุฌููุน ูุญุงูุธู</p>
                    </div>
                </div>
            </div>

            <!-- FEES TAB -->
            <div id="calc-fees" class="calc-tab-content">
                <div class="glass-card tool-card">
                    <div class="broker-selector">
                        <div class="broker-option selected" onclick="window.selectBroker('thndr', this)">
                            <i class="fa-solid fa-bolt"></i> Thndr
                        </div>
                        <div class="broker-option" onclick="window.selectBroker('other', this)">
                            <i class="fa-solid fa-building-columns"></i> ุชูููุฏู
                        </div>
                    </div>
                    <div class="compact-grid">
                        <div class="input-group-modern">
                            <label>ุณุนุฑ ุงูุดุฑุงุก</label>
                            <input type="number" id="c-buy" placeholder="0.00" oninput="window.calcCommission()">
                        </div>
                        <div class="input-group-modern">
                            <label>ุณุนุฑ ุงูุจูุน</label>
                            <input type="number" id="c-sell" placeholder="0.00" oninput="window.calcCommission()">
                        </div>
                    </div>
                    <div class="input-group-modern" style="margin-top: 10px;">
                        <label>ุงููููุฉ</label>
                        <input type="number" id="c-qty" placeholder="ุนุฏุฏ ุงูุฃุณูู" oninput="window.calcCommission()">
                    </div>
                    <div class="result-display-card">
                        <span class="rd-label">ุงูุฑุจุญ ุงูุตุงูู</span>
                        <h2 id="c-result" class="rd-value">0.00</h2>
                        <div class="rd-sub">ุฅุฌูุงูู ุงูุฑุณูู: <span id="c-fees">0.00</span></div>
                    </div>
                </div>
            </div>

            <!-- AVERAGES TAB -->
            <div id="calc-avg" class="calc-tab-content">
                <div class="glass-card tool-card">
                    <h4 class="section-label">ุงููุฑูุฒ ุงูุญุงูู</h4>
                    <div class="compact-grid">
                        <div class="input-group-modern">
                            <label>ุงููููุฉ</label>
                            <input type="number" id="avg-curr-qty" placeholder="0">
                        </div>
                        <div class="input-group-modern">
                            <label>ุงููุชูุณุท</label>
                            <input type="number" id="avg-curr-price" placeholder="0.00">
                        </div>
                    </div>
                    <h4 class="section-label">ุงูุดุฑุงุก ุงูุฌุฏูุฏ</h4>
                    <div class="compact-grid">
                        <div class="input-group-modern">
                            <label>ุงููููุฉ</label>
                            <input type="number" id="avg-new-qty" placeholder="0">
                        </div>
                        <div class="input-group-modern">
                            <label>ุงูุณุนุฑ</label>
                            <input type="number" id="avg-new-price" placeholder="0.00">
                        </div>
                    </div>
                    <button class="btn-action-glow" onclick="window.calcAverage()">ุงุญุณุจ ุงููุชูุณุท ุงูุฌุฏูุฏ</button>
                    <div class="result-display-card gold-theme" style="margin-top: 20px;">
                        <span class="rd-label">ุงููุชูุณุท ุงูุฌุฏูุฏ</span>
                        <h2 id="avg-result" class="rd-value">0.00</h2>
                    </div>
                </div>
            </div>

            <!-- RISK TAB -->
            <div id="calc-risk" class="calc-tab-content">
                <div class="glass-card tool-card">
                    <div class="input-group-modern">
                        <label>ุงููุจูุบ ุงููุฎุงุทุฑ ุจู ($) <span class="optional-badge">ุงุฎุชูุงุฑู</span></label>
                        <input type="number" id="rr-risk-amount" placeholder="ูุซูุงู 100" oninput="window.calcRR()">
                    </div>
                    <div class="input-group-modern" style="margin-top: 15px;">
                        <label>ุณุนุฑ ุงูุฏุฎูู</label>
                        <input type="number" id="rr-entry" placeholder="0.00" oninput="window.calcRR()"
                            class="highlight-input">
                    </div>
                    <div class="compact-grid" style="margin-top: 15px;">
                        <div class="input-group-modern success-theme">
                            <label>ุงููุฏู (TP)</label>
                            <input type="number" id="rr-target" placeholder="0.00" oninput="window.calcRR()">
                        </div>
                        <div class="input-group-modern danger-theme">
                            <label>ุงูููู (SL)</label>
                            <input type="number" id="rr-stop" placeholder="0.00" oninput="window.calcRR()">
                        </div>
                    </div>
                    <!-- Visualizer -->
                    <div class="risk-visualizer-container">
                        <div class="rr-bar-wrapper">
                            <div id="rr-bar-loss" class="rr-bar loss"></div>
                            <div class="rr-bar-entry"></div>
                            <div id="rr-bar-profit" class="rr-bar profit"></div>
                        </div>
                        <div class="rr-labels">
                            <span id="label-loss" class="text-danger">0%</span>
                            <span class="text-muted">Entry</span>
                            <span id="label-profit" class="text-green">0%</span>
                        </div>
                    </div>
                    <div class="compact-grid" style="margin-top: 15px;">
                        <div class="result-display-card compact">
                            <span class="rd-label">R:R Ratio</span>
                            <h3 id="rr-ratio" class="rd-value-sm">0 : 0</h3>
                        </div>
                        <div class="result-display-card compact blue-theme">
                            <span class="rd-label">ุงููููุฉ ุงูููุชุฑุญุฉ</span>
                            <h3 id="rr-qty" class="rd-value-sm">-</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- LESSONS SECTION (Trading Academy) -->
    <section id="lessons-section" class="view-section hidden">
        <header class="app-header" style="justify-content: space-between; direction: ltr;">
            <button class="btn-icon" onclick="window.setView('dashboard')"
                style="background:rgba(255,255,255,0.1); width:40px; height:40px; border-radius:12px;">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h1 class="logo-text" style="font-size:1.5rem; order:2;">ุฃูุงุฏูููุฉ ุงูุชุฏุงูู <i
                    class="fa-solid fa-graduation-cap"></i></h1>
        </header>

        <div class="content-container">
            <!-- Strategy Wizard -->
            <div id="strategy-wizard" class="glass-card full-width" style="margin-top:10px">
                <div class="wizard-header">
                    <h2 class="section-title">ูุชุญ ูุฑูุฒ ุฌุฏูุฏ</h2>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="wiz-progress" style="width: 25%"></div>
                    </div>
                </div>

                <!-- Step 1: Risk -->
                <div class="wizard-step active" id="step-1">
                    <h3 class="step-title">๐ป ุงูุฌุงูุจ ุงููุธูู</h3>
                    <p class="step-desc">ูุจู ุฃู ุชููุฑ ูู ุงูุฑุจุญุ ููุฑ: ููุงุฐุง ูุฏ ุชูุดู ูุฐู ุงูุตููุฉุ</p>
                    <div class="input-group">
                        <label>ุณููุงุฑูู ุงููุดู (Pre-Mortem)</label>
                        <textarea id="lz-fail-scenario" class="main-input" rows="2"
                            placeholder="ูุซูุงู: ูุณุฑ ููููุ ุฃุฎุจุงุฑ ุณูุจูุฉุ ุชุตุญูุญ ุนุงู ููุณูู..."></textarea>
                    </div>
                    <div class="input-group">
                        <label>ุฃุณูุฃ ุฎุณุงุฑุฉ ูุญุชููุฉ (ููุณูุงู)</label>
                        <input type="text" id="lz-worst-loss" class="main-input"
                            placeholder="ูู ุชุชุญูู ุฎุณุงุฑุฉ 10% ูุซูุงูุ">
                    </div>
                </div>

                <!-- Step 2: Technical -->
                <div class="wizard-step" id="step-2">
                    <h3 class="step-title">๐ ุงูุฅุนุฏุงุฏ ุงูููู</h3>
                    <p class="step-desc">ููุงุฐุง ุชุฏุฎู ุงูุขู ุชุญุฏูุฏุงูุ</p>
                    <div class="input-group">
                        <label>ุฃุณุจุงุจ ุงูุฏุฎูู (ุงุฎุชุฑ ูุง ููุทุจู)</label>
                        <div class="checkbox-group">
                            <label class="cb-container">
                                <input type="checkbox" value="BREAKOUT" class="lz-reason"> ุงุฎุชุฑุงู ููุงููุฉ (Breakout)
                                <span class="checkmark"></span>
                            </label>
                            <label class="cb-container">
                                <input type="checkbox" value="SUPPORT" class="lz-reason"> ุงุฑุชุฏุงุฏ ูู ุฏุนู (Support)
                                <span class="checkmark"></span>
                            </label>
                            <label class="cb-container">
                                <input type="checkbox" value="INDICATOR" class="lz-reason"> ุฅุดุงุฑุฉ ูุคุดุฑ (RSI/MACD)
                                <span class="checkmark"></span>
                            </label>
                            <label class="cb-container">
                                <input type="checkbox" value="FUNDAMENTAL" class="lz-reason"> ูุงูู/ุฃุณุงุณู (News/Earnings)
                                <span class="checkmark"></span>
                            </label>
                        </div>
                    </div>
                    <div class="two-col-grid">
                        <div class="input-group">
                            <label>ุฏุนู 1 (ูุฑูุจ)</label>
                            <input type="number" id="lz-support1" class="main-input" placeholder="0.00">
                        </div>
                        <div class="input-group">
                            <label>ุฏุนู 2 (ููู)</label>
                            <input type="number" id="lz-support2" class="main-input" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <!-- Step 3: Allocation -->
                <div class="wizard-step" id="step-3">
                    <h3 class="step-title">๐ฐ ุฅุฏุงุฑุฉ ุงููุญูุธุฉ</h3>
                    <p class="step-desc">ูุง ุชุถุน ุงูุจูุถ ููู ูู ุณูุฉ ูุงุญุฏุฉ.</p>
                    <div class="input-group">
                        <label>ุฅุฌูุงูู ุงููุญูุธุฉ ุงูุญุงููุฉ</label>
                        <input type="number" id="lz-portfolio-size" class="main-input" placeholder="0.00">
                    </div>
                    <div class="input-group">
                        <label>ุงููุจูุบ ุงููุฎุตุต ููุตููุฉ</label>
                        <input type="number" id="lz-alloc-amount" class="main-input" placeholder="0.00"
                            oninput="window.checkAllocation()">
                    </div>
                    <div id="alloc-warning" class="warning-box hidden">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        <span>ุชุญุฐูุฑ: ุงููุจูุบ ูุชุฌุงูุฒ 15% ูู ุงููุญูุธุฉ! ุชุฃูุฏ ุฃูู ูุฑุชุงุญ ููุฐู ุงููุฎุงุทุฑุฉ.</span>
                    </div>
                </div>

                <!-- Step 4: Execution Plan -->
                <div class="wizard-step" id="step-4">
                    <h3 class="step-title">๐ ุฎุทุฉ ุงูุฏุฎูู</h3>
                    <p class="step-desc">ููู ุณุชููุฐ ุงูุตููุฉุ</p>
                    <div class="input-group">
                        <label>ููุน ุงูุงุณุชุฑุงุชูุฌูุฉ</label>
                        <div class="segmented-control">
                            <button class="seg-btn active" onclick="window.setStrategy('DEFENSIVE')">ุฏูุงุนูุฉ ๐ก๏ธ</button>
                            <button class="seg-btn" onclick="window.setStrategy('BALANCED')">ูุชูุงุฒูุฉ โ๏ธ</button>
                            <button class="seg-btn" onclick="window.setStrategy('AGGRESSIVE')">ูุฌูููุฉ โ๏ธ</button>
                        </div>
                    </div>
                    <div id="strategy-breakdown" class="strategy-results"></div>
                </div>

                <div class="wizard-nav">
                    <button id="wiz-prev" class="btn-secondary hidden" onclick="window.changeStep(-1)">ุงูุณุงุจู</button>
                    <button id="wiz-next" class="btn-primary" onclick="window.changeStep(1)">ุงูุชุงูู</button>
                    <button id="wiz-save" class="btn-success hidden" onclick="window.saveStrategy()">ุญูุธ ุงูุฎุทุฉ
                        โ</button>
                </div>
            </div>

            <!-- History -->
            <div class="glass-card full-width" style="margin-top:20px">
                <h3 class="section-title" style="font-size:1.2rem; margin-bottom:15px">ุณุฌู ุงูุงุณุชุฑุงุชูุฌูุงุช</h3>
                <div id="strategy-history-list" class="transaction-list">
                    <div class="empty-state">
                        <p>ูุง ุชูุฌุฏ ุฎุทุท ูุญููุธุฉ ุจุนุฏ</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- JOURNAL SECTION -->
    <section id="journal-section" class="view-section hidden">
        <div class="container">
            <div class="journal-header">
                <div class="journal-title-box">
                    <h2>ุณุฌู ุงูุตููุงุช</h2>
                    <p>ุฅุฏุงุฑุฉ ุตููุงุชู ูุชุญููู ุงูุฃุฏุงุก</p>
                </div>
                <button class="btn-add-journal" onclick="window.openNewCenterModal()">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div class="journal-stats-row">
                <div class="j-stat-card">
                    <span class="j-label">ูุณุจุฉ ุงููุฌุงุญ</span>
                    <strong id="j-winrate">--%</strong>
                </div>
                <div class="j-stat-card">
                    <span class="j-label">ุงูุนุงุฆุฏ / ุงููุฎุงุทุฑุฉ</span>
                    <strong id="j-avg-rr">--</strong>
                </div>
                <div class="j-stat-card">
                    <span class="j-label">ุฅุฌูุงูู ุงูุตููุงุช</span>
                    <strong id="j-total-trades">0</strong>
                </div>
            </div>

            <div class="journal-filters">
                <button class="j-filter active" data-filter="ALL" onclick="window.setJournalFilter('ALL')">ุงููู</button>
                <button class="j-filter" data-filter="WIN" onclick="window.setJournalFilter('WIN')">ุฑุงุจุญุฉ</button>
                <button class="j-filter" data-filter="LOSS" onclick="window.setJournalFilter('LOSS')">ุฎุงุณุฑุฉ</button>
                <button class="j-filter" data-filter="OPEN" onclick="window.setJournalFilter('OPEN')">ููุชูุญุฉ</button>
            </div>

            <div class="glass-card leakage-card">
                <div class="leakage-header"
                    onclick="document.getElementById('leakage-list').classList.toggle('hidden')">
                    <h4><i class="fa-solid fa-fire text-danger"></i> ุชูููุฉ ุงูุฃุฎุทุงุก (Leakage)</h4>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div id="leakage-list" class="leakage-list hidden">
                    <div style="text-align:center; padding:10px; color:#888; font-size:0.8rem">
                        ุญุณุงุจ ุงูุชูููุฉ ูุชุทูุจ ุฅุบูุงู ุตููุงุช ุฎุงุณุฑุฉ ูุญุฏุฏุฉ ูุฃุฎุทุงุก
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>
            <h4 style="margin-bottom:15px; color:#ccc;">ุงููุฑุงูุฒ ุงูููุชูุญุฉ (Active Campaigns)</h4>
            <div id="active-centers-list" class="centers-list">
                <div class="empty-state">
                    <i class="fa-solid fa-layer-group"></i>
                    <p>ูุง ุชูุฌุฏ ูุฑุงูุฒ ูุดุทุฉ ุญุงููุงู</p>
                </div>
            </div>
        </div>
    </section>

    <!-- NEW CENTER MODAL -->
    <dialog id="new-center-modal" class="modal">
        <div class="modal-content glass-card input-modal">
            <div class="modal-header">
                <h3><i class="fa-solid fa-chess-knight"></i> ูุชุญ ูุฑูุฒ ุฌุฏูุฏ</h3>
                <button onclick="document.getElementById('new-center-modal').close()" class="close-modal-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <input type="hidden" id="jc-edit-id">
            <div class="input-group">
                <div class="compact-grid">
                    <input type="text" id="jc-asset" class="main-input" placeholder="ุงูุฃุตู (ูุซูุงู GOLD, AAPL)">
                    <select id="jc-direction" class="main-input">
                        <option value="LONG">Long ๐ข</option>
                        <option value="SHORT">Short ๐ด</option>
                    </select>
                </div>
                <label>ุงูุงุณุชุฑุงุชูุฌูุฉ / ุงูุณุจุจ (Setup)</label>
                <select id="jc-strategy" class="main-input">
                    <option value="BREAKOUT">ุงุฎุชุฑุงู (Breakout)</option>
                    <option value="REVERSAL">ุงูุนูุงุณ (Reversal)</option>
                    <option value="TREND_FOLLOWING">ุชุชุจุน ุงุชุฌุงู (Trend Following)</option>
                    <option value="NEWS">ุฎุจุฑ (News Play)</option>
                    <option value="OTHER">ุฃุฎุฑู</option>
                </select>
                <textarea id="jc-thesis" class="main-input" rows="3"
                    placeholder="ููุงุฐุง ุชุฏุฎู ูุฐู ุงูุตููุฉุ (Thesis)"></textarea>
                <div class="compact-grid">
                    <input type="number" id="jc-stop" class="main-input" placeholder="ููู ุงูุฎุณุงุฑุฉ (Stop Loss)">
                    <input type="number" id="jc-target" class="main-input" placeholder="ุงููุฏู (Take Profit)">
                </div>
            </div>
            <button id="btn-save-center" class="btn-primary w-100" onclick="window.submitNewCenter()">ูุชุญ
                ุงููุฑูุฒ</button>
        </div>
    </dialog>

    <!-- ADD EXECUTION MODAL -->
    <dialog id="add-execution-modal" class="modal">
        <div class="modal-content glass-card input-modal">
            <div class="modal-header">
                <h3 id="add-execution-title"><i class="fa-solid fa-pen-to-square"></i> ุชุณุฌูู ุชูููุฐ</h3>
                <button onclick="document.getElementById('add-execution-modal').close()" class="close-modal-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <input type="hidden" id="exec-center-id">
            <input type="hidden" id="exec-edit-id">
            <div class="input-group">
                <div style="margin-bottom: 10px;">
                    <label style="font-size:0.8rem; color:#aaa; display:block; margin-bottom:4px;">ุงููุญูุธุฉ
                        (Portfolio)</label>
                    <select id="exec-portfolio" class="main-input">
                        <option value="NONE">ุจุฏูู ูุญูุธุฉ (Global)</option>
                    </select>
                </div>
                <div class="compact-grid">
                    <select id="exec-type" class="main-input">
                        <optgroup label="Drying In (Dukhul)">
                            <option value="OPEN">ูุชุญ ูุฑูุฒ (Open Position)</option>
                            <option value="ADD">ุชุนุฒูุฒ - ูุน ุงูุงุชุฌุงู (Add to Winner)</option>
                            <option value="AVERAGE">ุชูุณุท - ุชุจุฑูุฏ (Average Down)</option>
                        </optgroup>
                        <optgroup label="Taking Profit (Ribh)">
                            <option value="TP_PARTIAL">ุฌูู ุฃุฑุจุงุญ ุฌุฒุฆู (Partial TP)</option>
                            <option value="TP_FULL">ุฅุบูุงู ุจุฑุจุญ (Full Profit)</option>
                        </optgroup>
                        <optgroup label="Cutting Loss (Khasara)">
                            <option value="SL_PARTIAL">ููู ุฎุณุงุฑุฉ ุฌุฒุฆู (Partial Stop)</option>
                            <option value="SL_FULL">ููู ุฎุณุงุฑุฉ ูุงูู (Stop Loss)</option>
                            <option value="CUT_EARLY">ุฎุฑูุฌ ูุฏูู ูุจูุฑ (Cut Early)</option>
                        </optgroup>
                    </select>
                    <input type="date" id="exec-date" class="main-input">
                </div>
                <div class="compact-grid">
                    <input type="number" id="exec-price" class="main-input" placeholder="ุงูุณุนุฑ">
                    <input type="number" id="exec-qty" class="main-input" placeholder="ุงููููุฉ">
                </div>
                <div class="input-group" style="margin-top:10px;">
                    <label style="font-size:0.8rem; color:#aaa;">ุฎุทุฃ ุงุฑุชูุจุชูุ (Mistake)</label>
                    <select id="exec-mistake" class="main-input">
                        <option value="NONE">ูุง ููุฌุฏ (ุชุฏุงูู ุณููู) โ</option>
                        <option value="FOMO">ุชุณุฑุน (FOMO) ๐โโ๏ธ</option>
                        <option value="HESITATION">ุชุฑุฏุฏ (Hesitation) ๐ข</option>
                        <option value="REVANGE">ุงูุชูุงู (Revenge) ๐ก</option>
                        <option value="NO_PLAN">ุจุฏูู ุฎุทุฉ ๐</option>
                        <option value="EARLY_EXIT">ุฎุฑูุฌ ูุจูุฑ (Weak Hands) ๐คฒ</option>
                        <option value="LATE_EXIT">ุทูุน (Held too long) ๐ค</option>
                    </select>
                </div>
                <hr style="border-color:rgba(255,255,255,0.1); margin:15px 0;">
                <label><i class="fa-solid fa-brain text-purple"></i> ุงูุญุงูุฉ ุงูููุณูุฉ (Psychology)</label>
                <div class="tags-container">
                    <div class="tag-check">
                        <input type="checkbox" id="tag-fomo" value="FOMO">
                        <label for="tag-fomo">FOMO ๐ฑ</label>
                    </div>
                    <div class="tag-check">
                        <input type="checkbox" id="tag-revenge" value="REVENGE">
                        <label for="tag-revenge">ุงูุชูุงู ๐ก</label>
                    </div>
                    <div class="tag-check">
                        <input type="checkbox" id="tag-calm" value="CALM">
                        <label for="tag-calm">ูุงุฏุฆ ๐งโโ๏ธ</label>
                    </div>
                    <div class="tag-check">
                        <input type="checkbox" id="tag-confident" value="CONFIDENT">
                        <label for="tag-confident">ูุงุซู ๐</label>
                    </div>
                </div>
                <textarea id="exec-notes" class="main-input" rows="2" placeholder="ููุงุญุธุงุช ุฅุถุงููุฉ..."></textarea>
            </div>
            <button id="btn-save-exec" class="btn-primary w-100" onclick="window.submitExecution()">ุญูุธ ุงูุชูููุฐ</button>
        </div>
    </dialog>

    <section id="settings-section" class="view-section hidden">
        <div class="container">
            <h3>ุงูุฅุนุฏุงุฏุงุช</h3>
            <div class="glass-card">
                <button class="btn-primary" onclick="window.exportBackup()"
                    style="margin-bottom:10px; background:#2c2c2e">
                    <i class="fa-solid fa-download"></i> ุชุตุฏูุฑ ุงูุจูุงูุงุช (JSON)
                </button>
                <button class="btn-primary" onclick="document.getElementById('backup-upload').click()"
                    style="margin-bottom:10px; background:#2c2c2e">
                    <i class="fa-solid fa-upload"></i> ุงุณุชุนุงุฏุฉ ูุณุฎุฉ backup
                </button>
                <input type="file" id="backup-upload" style="display:none" onchange="window.importBackup(this)">
            </div>
            <button class="btn-primary" style="background:var(--danger)" id="logout-btn-settings">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
        </div>
    </section>

    <!-- Bottom Navigation (Reconstructed) -->
    <nav class="bottom-nav" id="main-nav">
        <button class="nav-item active" id="nav-home" onclick="window.setView('dashboard')">
            <i class="fa-solid fa-house"></i>
        </button>
        <button class="nav-item" id="nav-calculator" onclick="window.setView('calculator')">
            <i class="fa-solid fa-calculator"></i>
        </button>
        <button class="nav-item" id="nav-journal" onclick="window.setView('journal')">
            <i class="fa-solid fa-book-journal-whills"></i>
        </button>
        <button class="nav-item" id="nav-lessons" onclick="window.setView('lessons')">
            <i class="fa-solid fa-graduation-cap"></i>
        </button>
        <button class="nav-item" id="nav-settings" onclick="window.setView('settings')">
            <i class="fa-solid fa-gear"></i>
        </button>
    </nav>

    <!-- PWA Install Prompt Modal -->
    <dialog id="pwa-install-modal" class="modal">
        <div class="modal-content glass-card" style="text-align: center;">
            <div class="pwa-prompt-content">
                <div class="pwa-icon">
                    <img src="./assets/icon-192.png" alt="App Icon"
                        onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'">
                </div>
                <div class="pwa-text">
                    <h3>ุชุซุจูุช ุงูุชุทุจูู ๐ฒ</h3>
                    <p>ุงุญุตู ุนูู ุชุฌุฑุจุฉ ุฃุณุฑุน ูุฃูุถู ุจุชุซุจูุช ุงูุชุทุจูู ุนูู ุฌูุงุฒู.</p>
                </div>
            </div>
            <div class="pwa-actions">
                <button id="btn-pwa-install" class="btn-primary w-100">ุชุซุจูุช ุงูุขู</button>
                <button onclick="document.getElementById('pwa-install-modal').close()" class="btn-text">ููุณ
                    ุงูุขู</button>
            </div>
        </div>
    </dialog>

    <script type="module" src="app.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW Registered!', reg))
                    .catch(err => console.log('SW Failed:', err));
            });
        }
    </script>
</body>

</html>