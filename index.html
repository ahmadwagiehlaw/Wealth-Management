<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Wealth</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Inter:wght@400;700;800&display=swap"
        rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>

<body data-view="auth">

    <div class="ambient-glow"></div>

    <!-- ูุธุงู ุงูุฅุดุนุงุฑุงุช -->
    <div id="toast-container"></div>

    <!-- Global Ticker Removed from Body -->

    <section id="auth-section" class="view-section">
        <div class="container"
            style="height:80vh; display:flex; flex-direction:column; justify-content:center; text-align:center;">
            <i class="fa-solid fa-layer-group" style="font-size:3.5rem; color:var(--primary); margin-bottom:20px;"></i>
            <h1 style="margin:0 0 10px; font-size:1.8rem">My Wealth</h1>
            <p style="color:#888; margin-bottom:40px; font-size:0.9rem">ุฅุฏุงุฑุฉ ุงูุฃุตูู ููุญุงูุงุฉ ุงูุณูู</p>

            <input type="email" id="login-email" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู">
            <input type="password" id="login-password" placeholder="ูููุฉ ุงููุฑูุฑ">
            <button class="btn-primary" id="login-btn">ุชุณุฌูู ุงูุฏุฎูู</button>
        </div>
    </section>

    <section id="dashboard-section" class="view-section hidden">
        <div class="container">
            <!-- Market Ticker (Moved to Top) -->
            <div class="market-ticker-inline glass-card-nav" id="ticker-bar"
                style="margin-bottom: 15px; padding: 8px 15px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:0.8rem; color:#aaa;">
                    <i class="fa-solid fa-spinner fa-spin"></i> ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงูุณูู...
                </span>
                <!-- Manual Install Trigger -->
                <button id="manual-install-trigger" class="icon-btn-sm"
                    style="background:transparent; color:var(--primary); display:none;"
                    onclick="document.getElementById('pwa-install-modal').showModal()">
                    <i class="fa-solid fa-download"></i>
                </button>
            </div>

            <!-- ุจุทุงูุฉ ุงูุซุฑูุฉ ุงูุฑุฆูุณูุฉ ูุน Lottie -->
            <div class="glass-card main-wealth-card">
                <div class="wealth-header">
                    <div class="wealth-text">
                        <div class="mc-label">ุฅุฌูุงูู ุงูุซุฑูุฉ</div>
                        <h1 class="mc-value" id="total-net-worth">...</h1>
                        <div class="wealth-change" id="wealth-change">
                            <i class="fa-solid fa-arrow-up"></i> <span>--</span>
                        </div>
                    </div>
                    <div id="lottie-wealth" style="width: 120px; height: 120px;"></div>
                </div> <!-- Close wealth-header -->

                <div class="wealth-stats-row">
                    <div class="w-stat">
                        <i class="fa-solid fa-wallet"></i>
                        <span id="total-invested" class="ws-value">EGP 0</span>
                        <span class="ws-label">ุฑุฃุณ ุงููุงู</span>
                    </div>
                    <div class="w-stat">
                        <i class="fa-solid fa-chart-line"></i>
                        <span id="total-pnl" class="ws-value success-text">EGP 0</span>
                        <span class="ws-label">ุงูุฃุฑุจุงุญ</span>
                    </div>
                    <div class="w-stat">
                        <i class="fa-solid fa-percent"></i>
                        <span id="global-avg-return" class="ws-value">0%</span>
                        <span class="ws-label">ูุชูุณุท ุงูุนุงุฆุฏ</span>
                    </div>
                </div>
            </div> <!-- Close main-wealth-card -->

            <!-- Market Ticker Moved Up (Line 76 removed) -->

            <div class="section-header">
                <h3>ุงููุญุงูุธ</h3>
                <button class="btn-add-stylish" id="create-portfolio-btn">
                    <i class="fa-solid fa-plus"></i> ุฅุถุงูุฉ
                </button>
            </div>

            <div id="portfolios-container"></div>
    </section>

    <!-- Create Portfolio Modal -->
    <dialog id="create-portfolio-modal" class="modal">
        <div class="modal-content glass-card">
            <button onclick="document.getElementById('create-portfolio-modal').close()"
                style="position:absolute; top:20px; left:20px; background:none; border:none; color:#888; font-size:1.2rem; cursor:pointer;">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <h3 style="margin-bottom: 20px;">ูุญูุธุฉ ุฌุฏูุฏุฉ</h3>
            <div class="input-group">
                <label>ุงุณู ุงููุญูุธุฉ</label>
                <input type="text" id="new-p-name" placeholder="ูุซูุงู: Thndr, WayBetter...">
            </div>

            <div class="input-group">
                <label>ุงูุนููุฉ</label>
                <div class="currency-selector">
                    <input type="radio" name="p-curr" value="EGP" id="curr-egp" checked>
                    <label for="curr-egp" class="radio-label">EGP (ุฌ.ู)</label>

                    <input type="radio" name="p-curr" value="USD" id="curr-usd">
                    <label for="curr-usd" class="radio-label">USD ($)</label>
                </div>
            </div>

            <div class="input-group">
                <label>ุฑุฃุณ ุงููุงู ุงููุจุฏุฆู (ุฅูุฏุงุน)</label>
                <input type="number" id="new-p-cap" placeholder="0">
            </div>

            <div class="modal-actions">
                <button class="btn-text" onclick="window.closeModal()">ุฅูุบุงุก</button>
                <button class="btn-primary" onclick="window.submitNewPortfolio()">ุฅูุดุงุก</button>
            </div>
        </div>
    </dialog>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
    </div>
    <section id="details-section" class="view-section hidden">
        <div class="container">
            <!-- Header & Actions -->
            <div class="details-header">
                <button class="btn-icon" onclick="window.setView('dashboard')">
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                <div class="header-title-wrapper">
                    <h2 id="d-p-name">...</h2>
                    <button class="btn-edit-icon" onclick="window.editPortfolioCapital()" title="ุชุนุฏูู ุฑุฃุณ ุงููุงู">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                </div>
                <button class="btn-icon danger" onclick="window.deleteCurrentPortfolio()">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>

            <!-- New Hero Analytics Card -->
            <div class="hero-analytics-card">
                <div class="hero-main-value">
                    <span class="currency-label" id="d-p-currency">EGP</span>
                    <div style="display:flex; align-items:center; gap:10px; justify-content:center">
                        <span id="d-p-val" class="hero-number">0</span>
                        <button class="btn-update-balance" onclick="window.updateCurrentBalance()"
                            title="ุชุญุฏูุซ ุงูุฑุตูุฏ ุงูุญุงูู">
                            <i class="fa-solid fa-rotate"></i> ุชุญุฏูุซ ุงููููุฉ
                        </button>
                    </div>
                </div>

                <div class="hero-stats-row">
                    <!-- Profit/Loss Block -->
                    <div class="hero-stat-item">
                        <div class="stat-icon-box" id="pnl-icon-box">
                            <i id="pnl-icon" class="fa-solid fa-chart-line"></i>
                        </div>
                        <div class="stat-text-col">
                            <span class="stat-label-tiny">ุงูุฑุจุญ/ุงูุฎุณุงุฑุฉ</span>
                            <span id="d-p-profit" class="stat-number-small">0</span>
                        </div>
                    </div>

                    <div class="vertical-divider"></div>

                    <!-- ROI Block -->
                    <div class="hero-stat-item">
                        <div class="stat-icon-box">
                            <i class="fa-solid fa-percent"></i>
                        </div>
                        <div class="stat-text-col">
                            <span class="stat-label-tiny">ุงูุนุงุฆุฏ %</span>
                            <span id="d-p-roi" class="stat-number-small">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Secondary Stats Row (Deposits / Withdrawals) -->
                <div class="hero-stats-row secondary-stats">
                    <div class="hero-stat-item compact">
                        <span class="stat-label-tiny">ุฅุฌูุงูู ุงูุฅูุฏุงุน</span>
                        <span id="d-p-deposits" class="stat-number-tiny text-green">0</span>
                    </div>
                    <div class="vertical-divider mini"></div>
                    <div class="hero-stat-item compact">
                        <span class="stat-label-tiny">ุงูุฃุฑุจุงุญ ุงููุณุญูุจุฉ</span>
                        <span id="d-p-withdrawals" class="stat-number-tiny text-danger">0</span>
                    </div>
                    <div class="vertical-divider mini"></div>
                    <div class="hero-stat-item compact">
                        <span class="stat-label-tiny">ูุชูุณุท ุงูุนุงุฆุฏ</span>
                        <span id="d-p-avg-return" class="stat-number-tiny text-blue">0%</span>
                    </div>
                </div>
            </div>

            <!-- Background decoration -->
            <div class="hero-bg-glow"></div>
        </div>

        <!-- Chart Section -->
        <div class="glass-card chart-container">
            <div class="chart-header-row">
                <h3 class="card-title">
                    <i class="fa-solid fa-wave-square" style="color:var(--primary)"></i>
                    ุงููููุฉ ุงูุณูููุฉ
                </h3>
                <div class="chart-filters">
                    <button class="filter-btn active" onclick="updateChartFilter('1W')">1W</button>
                    <button class="filter-btn" onclick="updateChartFilter('1M')">1M</button>
                    <button class="filter-btn" onclick="updateChartFilter('1Y')">1Y</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>

        <!-- Valuation History Section -->
        <div class="glass-card history-container">
            <div class="chart-header-row" style="margin-bottom:15px">
                <h3 class="card-title">
                    <i class="fa-solid fa-clock-rotate-left" style="color:var(--primary)"></i>
                    ุณุฌู ุงูููู
                </h3>
            </div>

            <div class="table-responsive">
                <table class="modern-table" id="valuation-history-table">
                    <thead>
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงููููุฉ</th>
                            <th>ุงูุญุงูุฉ</th>
                            <th style="text-align: left;">ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="history-list-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Empty State Placeholder -->
            <div id="history-empty-state" class="empty-state hidden">
                <i class="fa-solid fa-clipboard-list"></i>
                <p>ูุง ููุฌุฏ ุณุฌูุงุช ุจุนุฏ. ุงุจุฏุฃ ุจุชุญุฏูุซ ุฑุตูุฏ ุงููุญูุธุฉ.</p>
            </div>
        </div>

        <!-- Update Balance Modal with Cash Flow -->
        <dialog id="update-balance-modal" class="modal">
            <div class="modal-content glass-card">
                <button onclick="document.getElementById('update-balance-modal').close()"
                    style="position:absolute; top:20px; left:20px; background:none; border:none; color:#888; font-size:1.2rem; cursor:pointer;">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <h3>ุชุญุฏูุซ ุฑุตูุฏ ุงููุญูุธุฉ</h3>

                <div class="input-group">
                    <label>ุงูุชุงุฑูุฎ</label>
                    <input type="date" id="ub-date">
                </div>

                <div class="input-group">
                    <label>ุงููููุฉ ุงูุณูููุฉ ุงูุญุงููุฉ (Current Value)</label>
                    <input type="number" id="ub-value" placeholder="ุงููููุฉ ุงูุฅุฌูุงููุฉ ูููุญูุธุฉ ุงูุขู">
                    <small style="color:#888">ุฃุฏุฎู ุงููููุฉ ุงูุชู ุชุฑุงูุง ูู ุชุทุจูู ุงููุญูุธุฉ ุงูุฎุงุต ุจู ุงูุขู.</small>
                </div>

                <div class="section-divider"></div>

                <div class="input-group">
                    <label>ูู ููุช ุจุฅูุฏุงุน ุฃู ุณุญุจ ุฃููุงูุ</label>
                    <div class="currency-selector" style="margin-bottom:10px">
                        <input type="radio" name="ub-type" value="NONE" id="type-none" checked
                            onchange="toggleCashFlowInput()">
                        <label for="type-none" class="radio-label">ูุง ุชุบููุฑ</label>

                        <input type="radio" name="ub-type" value="DEPOSIT" id="type-dep"
                            onchange="toggleCashFlowInput()">
                        <label for="type-dep" class="radio-label">ุฅูุฏุงุน</label>

                        <input type="radio" name="ub-type" value="WITHDRAW" id="type-with"
                            onchange="toggleCashFlowInput()">
                        <label for="type-with" class="radio-label">ุณุญุจ</label>
                    </div>

                    <div id="cash-flow-input-container" class="hidden">
                        <input type="number" id="ub-cash-amount" placeholder="ูููุฉ ุงููุจูุบ ุงูููุฏุน/ุงููุณุญูุจ">
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-text" onclick="window.closeModal()">ุฅูุบุงุก</button>
                    <button class="btn-primary" onclick="window.submitBalanceUpdate()">ุญูุธ</button>
                </div>
            </div>
        </dialog>
        </div>
    </section>

    <!-- Old Journal Section Removed -->

    <section id="calculator-section" class="view-section hidden">
        <div class="container">
            <h3 style="margin-bottom:15px">ุฃุฏูุงุช ุงูุชุฏุงูู</h3>

            <div class="glass-card" style="padding:15px">
                <div class="segmented-control">
                    <button class="seg-btn active" onclick="window.switchCalcTab('fees', this)">ุงูุนูููุงุช</button>
                    <button class="seg-btn" onclick="window.switchCalcTab('avg', this)">ุงููุชูุณุทุงุช</button>
                    <button class="seg-btn" onclick="window.switchCalcTab('risk', this)">ุงููุฎุงุทุฑุฉ</button>
                </div>

                <div id="calc-fees" class="calc-tab-content active">
                    <div class="radio-group">
                        <div class="radio-label selected" onclick="window.selectBroker('thndr', this)">Thndr</div>
                        <div class="radio-label" onclick="window.selectBroker('other', this)">ุชูููุฏู</div>
                    </div>
                    <div class="compact-grid">
                        <input type="number" id="c-buy" class="compact-input" placeholder="ุณุนุฑ ุงูุดุฑุงุก"
                            oninput="window.calcCommission()">
                        <input type="number" id="c-sell" class="compact-input" placeholder="ุณุนุฑ ุงูุจูุน"
                            oninput="window.calcCommission()">
                    </div>
                    <input type="number" id="c-qty" class="compact-input" placeholder="ุงููููุฉ"
                        oninput="window.calcCommission()" style="width:100%">

                    <div class="calc-result-box">
                        <div class="mc-label">ุงูุฑุจุญ ุงูุตุงูู</div>
                        <h2 id="c-result" style="margin:5px 0; direction:ltr; font-size:1.8rem">0.00</h2>
                        <div style="font-size:0.75rem; color:#888">ุงูุฑุณูู: <span id="c-fees">0.00</span></div>
                    </div>
                </div>

                <div id="calc-avg" class="calc-tab-content">
                    <div class="compact-grid">
                        <input type="number" id="avg-curr-qty" class="compact-input" placeholder="ุงููููุฉ ุงูุญุงููุฉ">
                        <input type="number" id="avg-curr-price" class="compact-input" placeholder="ุงููุชูุณุท ุงูุญุงูู">
                    </div>
                    <div class="compact-grid">
                        <input type="number" id="avg-new-qty" class="compact-input" placeholder="ูููุฉ ุฌุฏูุฏุฉ">
                        <input type="number" id="avg-new-price" class="compact-input" placeholder="ุณุนุฑ ุฌุฏูุฏ">
                    </div>
                    <button class="btn-primary" style="background:#222; margin-top:5px; padding:10px"
                        onclick="window.calcAverage()">ุงุญุณุจ</button>

                    <div class="calc-result-box">
                        <div class="mc-label">ุงููุชูุณุท ุงูุฌุฏูุฏ</div>
                        <h2 id="avg-result" style="margin:5px 0; color:var(--gold); font-size:1.8rem">0.00</h2>
                    </div>
                </div>

                <div id="calc-risk" class="calc-tab-content">
                    <input type="number" id="rr-entry" class="compact-input" placeholder="ุณุนุฑ ุงูุฏุฎูู"
                        oninput="window.calcRR()" style="width:100%; margin-bottom:10px">
                    <div class="compact-grid">
                        <input type="number" id="rr-target" class="compact-input" placeholder="ุงููุฏู"
                            oninput="window.calcRR()">
                        <input type="number" id="rr-stop" class="compact-input" placeholder="ุงูููู"
                            oninput="window.calcRR()">
                    </div>

                    <div class="calc-result-box">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                            <div style="font-size:0.8rem">ุฑุจุญ: <span class="text-green" id="rr-profit">0%</span></div>
                            <div style="font-size:0.8rem">ุฎุณุงุฑุฉ: <span class="text-danger" id="rr-loss">0%</span></div>
                        </div>
                        <div class="mc-label">ูุณุจุฉ ุงูุนุงุฆุฏ (R:R)</div>
                        <h2 id="rr-ratio" style="margin:5px 0; font-size:1.8rem">0 : 0</h2>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <section id="settings-section" class="view-section hidden">
        <div class="container">
            <h3>ุงูุฅุนุฏุงุฏุงุช</h3>
            <div class="glass-card">
                <button class="btn-primary" onclick="window.exportBackup()"
                    style="margin-bottom:10px; background:#2c2c2e">
                    <i class="fa-solid fa-download"></i> ุชุตุฏูุฑ ุงูุจูุงูุงุช (JSON)
                </button>
                <button class="btn-primary" onclick="document.getElementById('backup-upload').click()"
                    style="margin-bottom:10px; background:#2c2c2e">
                    <i class="fa-solid fa-upload"></i> ุงุณุชุนุงุฏุฉ ูุณุฎุฉ
                </button>
            </div>
            <button class="btn-primary" style="background:var(--danger)" id="logout-btn-settings">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
        </div>
    </section>

    <!-- JOURNAL SECTION -->
    <section id="journal-section" class="view-section hidden">
        <div class="container">
            <div class="journal-header">
                <div>
                    <h2 class="section-title">Trading Journal</h2>
                    <p class="section-subtitle">ุฅุญุตุงุฆูุงุช & ููุณูุฉ ุงูุชุฏุงูู</p>
                </div>
                <!-- "Start Campaign" Button -->
                <button class="btn-add-circle" onclick="window.openNewCenterModal()">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <!-- Stats Overview -->
            <div class="journal-stats-row">
                <div class="j-stat-card">
                    <span class="j-label">ูุณุจุฉ ุงููุฌุงุญ</span>
                    <strong id="j-winrate">--%</strong>
                </div>
                <div class="j-stat-card">
                    <span class="j-label">ุงูุนุงุฆุฏ ูููุฎุงุทุฑุฉ</span>
                    <strong id="j-avg-rr">--</strong>
                </div>
                <div class="j-stat-card">
                    <span class="j-label">ุฅุฌูุงูู ุงูุตููุงุช</span>
                    <strong id="j-total-trades">0</strong>
                </div>
            </div>

            <div class="journal-filters">
                <button class="j-filter active" data-filter="ALL" onclick="window.setJournalFilter('ALL')">ุงููู</button>
                <button class="j-filter" data-filter="WIN" onclick="window.setJournalFilter('WIN')">ุฑุงุจุญุฉ</button>
                <button class="j-filter" data-filter="LOSS" onclick="window.setJournalFilter('LOSS')">ุฎุงุณุฑุฉ</button>
                <button class="j-filter" data-filter="OPEN" onclick="window.setJournalFilter('OPEN')">ููุชูุญุฉ</button>
            </div>
            <!-- LEAKAGE HEATMAP (The Genius Addition) -->
            <div class="glass-card leakage-card">
                <div class="leakage-header"
                    onclick="document.getElementById('leakage-list').classList.toggle('hidden'); this.querySelector('.fa-chevron-down').classList.toggle('rotate-180');"
                    style="cursor:pointer">
                    <h4><i class="fa-solid fa-fire text-danger"></i> ุชูููุฉ ุงูุฃุฎุทุงุก (Leakage)</h4>
                    <i class="fa-solid fa-chevron-down transition-transform"></i>
                </div>
                <div id="leakage-list" class="leakage-list hidden">
                    <!-- Dynamic Content will be injected here -->
                    <div style="text-align:center; padding:10px; color:#888; font-size:0.8rem">
                        ุญุณุงุจ ุงูุชูููุฉ ูุชุทูุจ ุฅุบูุงู ุตููุงุช ุฎุงุณุฑุฉ ูุญุฏุฏุฉ ูุฃุฎุทุงุก
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>

            <h4 style="margin-bottom:15px; color:#ccc;">ุงููุฑุงูุฒ ุงูููุชูุญุฉ (Active Campaigns)</h4>
            <div id="active-centers-list" class="centers-list">
                <!-- Active Trade Centers Go Here -->
                <div class="empty-state">
                    <i class="fa-solid fa-layer-group"></i>
                    <p>ูุง ุชูุฌุฏ ูุฑุงูุฒ ูุดุทุฉ ุญุงููุงู</p>
                </div>
            </div>
        </div>
    </section>

    <!-- NEW CENTER MODAL (The War Room) -->
    <dialog id="new-center-modal" class="modal">
        <div class="modal-content glass-card input-modal">
            <div class="modal-header">
                <h3><i class="fa-solid fa-chess-knight"></i> ูุชุญ ูุฑูุฒ ุฌุฏูุฏ</h3>
                <button onclick="document.getElementById('new-center-modal').close()" class="close-modal-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <input type="hidden" id="jc-edit-id">

            <div class="input-group">
                <div class="compact-grid">
                    <input type="text" id="jc-asset" class="main-input" placeholder="ุงูุฃุตู (ูุซูุงู GOLD, AAPL)">
                    <select id="jc-direction" class="main-input">
                        <option value="LONG">Long ๐ข</option>
                        <option value="SHORT">Short ๐ด</option>
                    </select>
                </div>

                <label>ุงูุงุณุชุฑุงุชูุฌูุฉ / ุงูุณุจุจ (Setup)</label>
                <select id="jc-strategy" class="main-input">
                    <option value="BREAKOUT">ุงุฎุชุฑุงู (Breakout)</option>
                    <option value="REVERSAL">ุงูุนูุงุณ (Reversal)</option>
                    <option value="TREND_FOLLOWING">ุชุชุจุน ุงุชุฌุงู (Trend Following)</option>
                    <option value="NEWS">ุฎุจุฑ (News Play)</option>
                    <option value="OTHER">ุฃุฎุฑู</option>
                </select>

                <textarea id="jc-thesis" class="main-input" rows="3"
                    placeholder="ููุงุฐุง ุชุฏุฎู ูุฐู ุงูุตููุฉุ (Thesis)"></textarea>

                <div class="compact-grid">
                    <input type="number" id="jc-stop" class="main-input" placeholder="ููู ุงูุฎุณุงุฑุฉ (Stop Loss)">
                    <input type="number" id="jc-target" class="main-input" placeholder="ุงููุฏู (Take Profit)">
                </div>
            </div>

            <button id="btn-save-center" class="btn-primary w-100" onclick="window.submitNewCenter()">ูุชุญ
                ุงููุฑูุฒ</button>
        </div>
    </dialog>

    <!-- ADD EXECUTION MODAL (Log Trade) -->
    <dialog id="add-execution-modal" class="modal">
        <div class="modal-content glass-card input-modal">
            <div class="modal-header">
                <h3 id="add-execution-title"><i class="fa-solid fa-pen-to-square"></i> ุชุณุฌูู ุชูููุฐ</h3>
                <button onclick="document.getElementById('add-execution-modal').close()" class="close-modal-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <input type="hidden" id="exec-center-id">
            <input type="hidden" id="exec-edit-id">

            <div class="input-group">
                <!-- Portfolio Selection -->
                <div style="margin-bottom: 10px;">
                    <label style="font-size:0.8rem; color:#aaa; display:block; margin-bottom:4px;">ุงููุญูุธุฉ
                        (Portfolio)</label>
                    <select id="exec-portfolio" class="main-input">
                        <option value="NONE">ุจุฏูู ูุญูุธุฉ (Global)</option>
                        <!-- Options populated via JS -->
                    </select>
                </div>

                <div class="compact-grid">
                    <select id="exec-type" class="main-input">
                        <optgroup label="Drying In (Dukhul)">
                            <option value="OPEN">ูุชุญ ูุฑูุฒ (Open Position)</option>
                            <option value="ADD">ุชุนุฒูุฒ - ูุน ุงูุงุชุฌุงู (Add to Winner)</option>
                            <option value="AVERAGE">ุชูุณุท - ุชุจุฑูุฏ (Average Down)</option>
                        </optgroup>
                        <optgroup label="Taking Profit (Ribh)">
                            <option value="TP_PARTIAL">ุฌูู ุฃุฑุจุงุญ ุฌุฒุฆู (Partial TP)</option>
                            <option value="TP_FULL">ุฅุบูุงู ุจุฑุจุญ (Full Profit)</option>
                        </optgroup>
                        <optgroup label="Cutting Loss (Khasara)">
                            <option value="SL_PARTIAL">ููู ุฎุณุงุฑุฉ ุฌุฒุฆู (Partial Stop)</option>
                            <option value="SL_FULL">ููู ุฎุณุงุฑุฉ ูุงูู (Stop Loss)</option>
                            <option value="CUT_EARLY">ุฎุฑูุฌ ูุฏูู ูุจูุฑ (Cut Early)</option>
                        </optgroup>
                    </select>
                    <input type="date" id="exec-date" class="main-input">
                </div>

                <div class="compact-grid">
                    <input type="number" id="exec-price" class="main-input" placeholder="ุงูุณุนุฑ">
                    <input type="number" id="exec-qty" class="main-input" placeholder="ุงููููุฉ">
                </div>

                <hr style="border-color:rgba(255,255,255,0.1); margin:15px 0;">

                <label><i class="fa-solid fa-brain text-purple"></i> ุงูุญุงูุฉ ุงูููุณูุฉ (Psychology)</label>
                <div class="tags-container">
                    <div class="tag-check">
                        <input type="checkbox" id="tag-fomo" value="FOMO">
                        <label for="tag-fomo">FOMO ๐ฑ</label>
                    </div>
                    <div class="tag-check">
                        <input type="checkbox" id="tag-revenge" value="REVENGE">
                        <label for="tag-revenge">ุงูุชูุงู ๐ก</label>
                    </div>
                    <div class="tag-check">
                        <input type="checkbox" id="tag-calm" value="CALM">
                        <label for="tag-calm">ูุงุฏุฆ ๐งโโ๏ธ</label>
                    </div>
                    <div class="tag-check">
                        <input type="checkbox" id="tag-rushed" value="RUSHED">
                        <label for="tag-rushed">ุงุณุชุนุฌุงู ๐</label>
                    </div>
                    <div class="tag-check">
                        <input type="checkbox" id="tag-hesitant" value="HESITANT">
                        <label for="tag-hesitant">ุชุฑุฏุฏ ๐ฌ</label>
                    </div>
                    <div class="tag-check">
                        <input type="checkbox" id="tag-bored" value="BORED">
                        <label for="tag-bored">ููู ๐ฅฑ</label>
                    </div>
                    <div class="tag-check">
                        <input type="checkbox" id="tag-confident" value="CONFIDENT">
                        <label for="tag-confident">ูุงุซู ๐</label>
                    </div>
                </div>

                <div id="mistake-section" style="margin-top:10px;">
                    <label>ูู ูุงู ุฎุทุฃุ (Mistake Cost)</label>
                    <select id="exec-mistake" class="main-input">
                        <option value="NONE">ูุงุ ุชูููุฐ ุณููู โ</option>

                        <optgroup label="Psychological Errors">
                            <option value="FOMO">FOMO (ุฎูู ููุงุช ุงููุฑุตุฉ)</option>
                            <option value="REVENGE">Revenge Trading (ุชุฌุงุฑุฉ ุงูุชูุงููุฉ)</option>
                            <option value="GAMBLING">Gambling (ููุงูุฑุฉ ุจุฏูู ุชุญููู)</option>
                            <option value="HESITATION">Hesitation (ุชุฑุฏุฏ ูู ุงูุฏุฎูู)</option>
                            <option value="EARLY_EXIT">Early Exit (ุฎุฑูุฌ ูุจูุฑ ุฎููุงู)</option>
                        </optgroup>

                        <optgroup label="Technical Errors">
                            <option value="NO_STRATEGY">No Strategy (ุฏุฎูู ุนุดูุงุฆู)</option>
                            <option value="BAD_ENTRY">Bad Entry (ุฏุฎูู ูุชุฃุฎุฑ/ุณูุก)</option>
                            <option value="WIDE_STOP">Wide Stop (ููู ุฎุณุงุฑุฉ ูุจูุฑ)</option>
                            <option value="OVERSIZING">Oversizing (ุญุฌู ุตููุฉ ูุจูุฑ)</option>
                        </optgroup>

                        <optgroup label="Other Errors">
                            <option value="FAT_FINGER">Fat Finger (ุฎุทุฃ ูุชุงุจู)</option>
                            <option value="NEWS_PANIC">News Panic (ููุน ุฃุฎุจุงุฑ)</option>
                            <option value="TECH_ISSUE">Technical Issue (ุนุทู ููุตุฉ/ูุช)</option>
                            <option value="BAD_ADVICE">Bad Advice (ุชูุตูุฉ ูุงุดูุฉ)</option>
                        </optgroup>
                    </select>
                </div>

            </div>

            <button id="btn-save-exec" class="btn-primary w-100" onclick="window.submitExecution()">ุชุณุฌูู</button>
        </div>
    </dialog>

    <!-- REVIEW TIMELINE MODAL (The Story) -->
    <dialog id="review-timeline-modal" class="modal">
        <div class="modal-content glass-card input-modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fa-solid fa-clock-rotate-left"></i> ุณุฌู ุงูุชุฏุงููุงุช (Timeline)</h3>
                <button onclick="document.getElementById('review-timeline-modal').close()" class="close-modal-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div id="timeline-container" class="timeline-container">
                <!-- Dynamic Timeline Items -->
                <div class="empty-state">
                    <i class="fa-solid fa-spinner fa-spin"></i>
                    <p>ุฌุงุฑู ุชุญููู ุงูุณุฌู...</p>
                </div>
            </div>
        </div>
    </dialog>

    <nav class="glass-dock" id="main-nav">
        <button class="nav-item active" id="nav-home"><i class="fa-solid fa-house"></i></button>
        <button class="nav-item" id="nav-calculator"><i class="fa-solid fa-calculator"></i></button>
        <button class="nav-item" id="nav-journal"><i class="fa-solid fa-book-open"></i></button>
        <button class="nav-item" id="nav-settings"><i class="fa-solid fa-gear"></i></button>
    </nav>

    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-content" id="modal-box"></div>
    </div>

    <input type="file" id="backup-upload" accept=".json" style="display:none">
    <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv" style="display:none">

    <!-- Edit History Modal -->
    <dialog id="edit-history-modal" class="modal">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h3>ุชุนุฏูู ุงูุณุฌู</h3>
                <button onclick="document.getElementById('edit-history-modal').close()" class="close-modal-btn">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="input-group">
                <input type="hidden" id="edit-hist-id">

                <label>ุงููููุฉ ุงููุณุฌูุฉ</label>
                <input type="number" id="edit-hist-value" class="main-input" placeholder="0.00">

                <label>ุงูุชุงุฑูุฎ</label>
                <input type="date" id="edit-hist-date" class="main-input">

                <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">

                <label>ุญุฑูุฉ ูุงููุฉ (ุงุฎุชูุงุฑู)</label>
                <div class="cashflow-options">
                    <label class="radio-label">
                        <input type="radio" name="edit-cashflow-type" value="none" checked>
                        <span>ูุง ููุฌุฏ</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="edit-cashflow-type" value="deposit">
                        <span>ุฅูุฏุงุน</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="edit-cashflow-type" value="withdrawal">
                        <span>ุณุญุจ</span>
                    </label>
                </div>
                <input type="number" id="edit-hist-cashflow" class="main-input mt-2" placeholder="ูุจูุบ ุงูุฅูุฏุงุน/ุงูุณุญุจ"
                    style="display:none;">
            </div>
            <button class="btn-primary w-100" id="save-history-edit-btn">ุญูุธ ุงูุชุนุฏููุงุช</button>
        </div>
    </dialog>

    <!-- Custom Confirm Modal -->
    <dialog id="confirm-modal" class="modal">
        <div class="modal-content glass-card" style="text-align: center;">
            <i class="fa-solid fa-triangle-exclamation warning-icon"
                style="font-size: 3rem; color: #ffcc00; margin-bottom: 15px;"></i>
            <h3 id="confirm-title">ูู ุฃูุช ูุชุฃูุฏุ</h3>
            <p id="confirm-msg" style="color: #ccc; margin-bottom: 25px;">ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>
            <div class="modal-actions" style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn-secondary" onclick="document.getElementById('confirm-modal').close()">ุฅูุบุงุก</button>
                <button class="btn-primary" id="confirm-yes-btn" style="background: var(--danger);">ูุนูุ ุญุฐู</button>
            </div>
        </div>
    </dialog>

    <!-- PWA INSTALL MODAL -->
    <dialog id="pwa-install-modal" class="modal bottom-sheet">
        <div class="modal-content glass-card pwa-card">
            <div class="pwa-header">
                <div class="pwa-icon">
                    <img src="./assets/icon-192.png" alt="App Icon"
                        onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'">
                </div>
                <div class="pwa-text">
                    <h3>ุชุซุจูุช ุงูุชุทุจูู ๐ฑ</h3>
                    <p>ุงุญุตู ุนูู ุชุฌุฑุจุฉ ุฃุณุฑุน ูุฃูุถู ุจุชุซุจูุช ุงูุชุทุจูู ุนูู ุฌูุงุฒู.</p>
                </div>
            </div>
            <div class="pwa-actions">
                <button id="btn-pwa-install" class="btn-primary w-100">ุชุซุจูุช ุงูุขู</button>
                <button onclick="document.getElementById('pwa-install-modal').close()" class="btn-text">ููุณ
                    ุงูุขู</button>
            </div>
        </div>
    </dialog>

    <script type="module" src="app.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW Registered!', reg))
                    .catch(err => console.log('SW Failed:', err));
            });
        }
    </script>
</body>

</html>